
apiVersion: v1
kind: Namespace
metadata:
  name: keycloak
---
# ==============================================================================
#                                  SECRETS
# ==============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: keycloak-db-url-secret
  namespace: keycloak
type: Opaque
data:
  url: {{ db_url | string }}
---
apiVersion: v1
kind: Secret
metadata:
  name: keycloak-wildcard-tls
  namespace: keycloak
type: kubernetes.io/tls
data:
  tls.crt: {{encoded_cert}}
  tls.key: {{encoded_key}}
---
# ==============================================================================
#                                 DEPLOYMENT
# ==============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: keycloak
  namespace: keycloak
  labels:
    app: keycloak
spec:
  replicas: 2
  selector:
    matchLabels:
      app: keycloak
  template:
    metadata:
      labels:
        app: keycloak
      annotations:
        vault.hashicorp.com/agent-inject: "true"
        vault.hashicorp.com/tls-skip-verify: "true"
        vault.hashicorp.com/auth-path: "auth/mw"
        vault.hashicorp.com/role: "harmo-role"
        vault.hashicorp.com/agent-inject-secret-env: |
          harmonisation/keycloak/credentials
          harmonisation/keycloak_db/credentials
        vault.hashicorp.com/agent-inject-template-env: |
          export KC_DB_USERNAME='{{ with secret "harmonisation/data/keycloak_db/credentials" }}{{ .Data.data.username }}{{ end }}'
          export KEYCLOAK_ADMIN='{{ with secret "harmonisation/data/keycloak/credentials" }}{{ .Data.data.username }}{{ end }}'
          export KEYCLOAK_ADMIN_PASSWORD='{{ with secret "harmonisation/data/keycloak/credentials" }}{{ .Data.data.password }}{{ end }}'
    spec:
      containers:
        - name: keycloak
          image: {{ registry_url }}/quay.io/keycloak/keycloak:23.0.6
          command: ["/bin/sh"]
          args:
            - -c
            - |
              . /vault/secrets/env
              exec /opt/keycloak/bin/kc.sh start --cache-stack=kubernetes
          env:
            - name: KC_DB
              value: "postgres"
            - name: KC_DB_URL
              valueFrom:
                secretKeyRef:
                  name: keycloak-db-url-secret
                  key: url
            - name: KC_PROXY
              value: "edge"
            - name: KC_HOSTNAME
              value: "{{ prefix }}keycloak.{{ base_domain }}" 
            - name: KC_HEALTH_ENABLED
              value: "true"
            - name: QUARKUS_TRANSACTION_MANAGER_ENABLE_RECOVERY
              value: "true"
            - name: KC_CACHE
              value: "ispn"
            - name: jgroups.dns.query
              value: "keycloak-headless.keycloak.svc.cluster.local"
          ports:
            - name: http
              containerPort: 8080
            - name: jgroups-tcp
              containerPort: 7600
          readinessProbe:
            httpGet:
              path: /health/ready
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          livenessProbe:
            httpGet:
              path: /health/live
              port: http
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 3
          resources:
            requests:
              cpu: 500m
              memory: 1Gi
            limits:
              cpu: "1"
              memory: 2Gi
---
# ==============================================================================
#                             HEADLESS SERVICE (for HA)
# ==============================================================================
apiVersion: v1
kind: Service
metadata:
  name: keycloak-headless
  namespace: keycloak
  labels:
    app: keycloak
spec:
  clusterIP: None  # This makes the service headless
  selector:
    app: keycloak
  ports:
    - name: jgroups-tcp
      port: 7600
      targetPort: 7600
---
# ==============================================================================
#                                   SERVICE
# ==============================================================================
apiVersion: v1
kind: Service
metadata:
  name: keycloak
  namespace: keycloak
  labels:
    app: keycloak
spec:
  selector:
    app: keycloak
  ports:
    - protocol: TCP
      port: 8080
      targetPort: 8080
---
# ==============================================================================
#                                   INGRESS
# ==============================================================================
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: keycloak-ingress
  namespace: keycloak
  annotations:
    kubernetes.io/ingress.class: "nginx"
    nginx.ingress.kubernetes.io/proxy-buffer-size: "128k"
    nginx.ingress.kubernetes.io/affinity: "cookie"
spec:
  rules:
  - host: "{{ prefix }}keycloak.{{ base_domain }}" 
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: keycloak
            port:
              number: 8080
  tls:
  - hosts:
    - "{{ prefix }}keycloak.{{ base_domain }}" 
    secretName: keycloak-wildcard-tls
